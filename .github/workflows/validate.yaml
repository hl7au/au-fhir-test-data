name: Validate

on:
  workflow_dispatch:
    inputs:
      path:
        description: "Directory to validate"
        required: true
      resource_matcher:
        description: "Matcher for resources to validate, eg Patient*"
        default: '*'
      report_title:
        description: "Report title"
        default: "AU Core"
        required: true
      ig:
        description: "Implementation guide used to validate"
        default: 'hl7.fhir.au.core#2.0.0-ballot'
        required: true
      tx:
        description: "Terminology server"
        default: "https://tx.dev.hl7.org.au/fhir"
        required: true

jobs:
  Convert:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Install deps
      uses: ./.github/deps
    - name: Convert to json
      uses: ./.github/fhirmapping
    - id: git-diff-action
      run: echo "changed=$(git status --porcelain=v1 2>/dev/null | wc -l | tr -d '[:space:]')" >> "$GITHUB_OUTPUT"
    - if: steps.git-diff-action.outputs.changed != '0'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: Update generated files
    - name: Validate
      uses: ./.github/validate
      with:
        path: ${{ github.event.inputs.path }}
        ig: ${{ github.event.inputs.ig }}
        tx: ${{ github.event.inputs.tx }}
    - name: Report
      uses: ./.github/report
      with:
        title: ${{ github.event.inputs.report_title }}